#!/bin/bash
# This file based in part on the mkinitrafms script for the LFS LiveCD
# written by Alexander E. Patrakov
#
# Version 0.5.1

if [ -z $1 ] ; then
  echo 'Missing kernel version'
  exit 1
else 
  KERNEL_VERSION=$1
fi

if [ ! -d "/lib/modules/$1" ] ; then
  echo "No modules directory named $1"
  exit 1
fi

if [ ! -z $2 ] && [ "$2" = "cd" ] ; then
   CD=1
else
   CD=0
fi

DATADIR=/usr/share/mkinitramfs

if [ $CD -eq 1 ] ; then
  CDVERSION="lightcubecd-$3"
  CDBINEXTRA='blockdev dmsetup losetup'
  CDLIBEXTRA='libdevmapper.so.1.02 libm.so.6'
  INITRAMFS_FILE=/tmp/initramfs.gz
  INITIN=initcd.in
else
  CDBINEXTRA=''
  CDLIBEXTRA=''
  INITRAMFS_FILE=/boot/initrd.img-$KERNEL_VERSION
  INITIN=init.in
fi

function die {
   rm -rf $WDIR
   exit 1
}

DL=ld64-uClibc.so.0

# Create a temporrary working directory
WDIR=`mktemp -d`

# Create base directory structure
mkdir -p $WDIR/{bin,dev,etc/{modprobe.d,udev/rules.d},lib/firmware,sbin,sys,proc}
touch $WDIR/etc/modprobe.d/modprobe.conf

# Create necessary device nodes
mknod -m 640 $WDIR/dev/console c 5 1
mknod -m 664 $WDIR/dev/null c 1 3

# Install the udev configuration files
cp /etc/udev/udev.conf $WDIR/etc/udev/udev.conf
for file in $(find /etc/udev/rules.d/ -type f)
do
    cp -v $file $WDIR/etc/udev/rules.d
done

if [ $CD -eq 0 ] ; then
    if [ -f /etc/mdadm.conf ] ; then cp /etc/mdadm.conf $WDIR/etc ; fi
fi 

# Install the init file
if [ $CD -eq 1 ] ; then
    xzcat $DATADIR/$INITIN | sed "s/__VERSION__/$CDVERSION/" > $WDIR/init
    chmod 0755 $WDIR/init
else
    install -m0755 $DATADIR/$INITIN $WDIR/init
fi

# Install basic binaries
for f in busybox $CDBINEXTRA
do
  file=$(type -p $f)
  if [ ! -z $file ] ; then
    cp $file $WDIR/bin
    if [ "$file" = "busybox" ] ; then
      cmds=`$WDIR/bin/busybox --help|grep "^Currently defined functions:-*$" -A10|grep \,`
      for cmd in $cmds ; do
         ln -s busybox $WDIR/bin/$cmd
      done
    fi
  else
    echo "Missing required binary: $f"
    die
  fi
done

for f in udevadm udevd modprobe
do
  file=$(type -p $f)
  if [ ! -z $file ] ; then
    cp $file $WDIR/sbin
  else
    echo "Missing required binary: $f"
    die
  fi
done

# Install libraries
for l in $DL $CDLIBEXTRA \
 librt.so.0 \
 libpthread.so.0 \
 libc.so.0 \
 libdl.so.0 \
 libz.so.1
do
  file=$(PATH=/lib:/usr/lib type -p $l)
  if [ ! -z $file ] ; then
    cp $file $WDIR/lib
  else
    echo "Missing required library: $l"
    die
  fi
done
cp -a /lib/udev $WDIR/lib

# Install the kernel modules
find /lib/modules/$KERNEL_VERSION/kernel/{crypto,fs,lib} \
 /lib/modules/$KERNEL_VERSION/kernel/drivers/{block,ata,md,firewire,scsi,usb/{host,storage},message,pcmcia,virtio} \
 -type f | cpio --make-directories -p $WDIR
depmod -b $WDIR $KERNEL_VERSION

( cd $WDIR ; find . | cpio -o -H newc | gzip -9 ) > $INITRAMFS_FILE

# Remove the temporary directory
rm -rf $WDIR
