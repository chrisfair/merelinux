pkgname=(linux linux-headers)
pkgver=4.4.2
pkgrel=1
pkgdesc='The Linux kernel'
arch=(x86_64)
url='http://www.kernel.org'
license=(GPL2)
groups=(base)
depends=()
makedepends=(bc perl)
options=()
changelog=ChangeLog
source=(
    "https://www.kernel.org/pub/linux/kernel/v4.x/linux-$pkgver.tar.xz"
    'linux-config'
)

sha256sums=(
    82fd2a22a9efd81200e08bc2d316ebf3265822f190bbac4ca0677bb42cf08626
    fe9c3f97b6ea3d53416604348648d5eb57e7838d3ab225337f489698e18a7088
)

build() {
    cd "${srcdir}/${pkgbase}-${pkgver}"
    # Something in the linux src wants gnu sed, so just be lazy for now and
    # give it what it wants
    sudo pacman -S --force --noconfirm sed
    make mrproper
    cp "${srcdir}/linux-config" .config
    make $MAKEFLAGS
}

package_linux() {
    cd "${srcdir}/${pkgbase}-${pkgver}"
    install -d "${pkgdir}/boot"
    install 'arch/x86_64/boot/bzImage' "${pkgdir}/boot/vmlinux"
}

package_linux-headers() {
    cd "${srcdir}/${pkgbase}-${pkgver}"
    make INSTALL_HDR_PATH=dest HOSTCFLAGS="-D_GNU_SOURCE" headers_install
    cd "${srcdir}/${pkgbase}-${pkgver}/dest"
    find include ! -type d -name "*.h" | cpio -dumpv "${pkgdir}"
}
