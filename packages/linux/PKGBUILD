pkgname=(linux linux-headers)
pkgver=3.19.2
pkgrel=1
pkgdesc='The Linux kernel'
arch=(x86_64)
url='http://www.kernel.org'
license=(GPL2)
groups=(base)
depends=()
makedepends=(bc perl)
options=()
changelog=ChangeLog
source=(
    "https://www.kernel.org/pub/linux/kernel/v3.x/linux-$pkgver.tar.xz"
    'linux-config'
)

sha256sums=(
    0c0ee420dc8d4f6239fab072351c7a2ce6a881028d5ab2d162ec667fdd750b2d
    aadb52d5ec9100d3ffe1e322fe472a53bd4912deb700140b9bdbd01039fe7321
)

build() {
    cd "${srcdir}/${pkgbase}-${pkgver}"
    # Something in the linux src wants gnu sed, so just be lazy for now and
    # give it what it wants
    sudo pacman -S --force --noconfirm sed
    sed -i 's@ ERR@@' scripts/link-vmlinux.sh
    make mrproper
    cp "${srcdir}/linux-config" .config
    make $MAKEFLAGS
}

package_linux() {
    cd "${srcdir}/${pkgbase}-${pkgver}"
    install -d "${pkgdir}/boot"
    install 'arch/x86_64/boot/bzImage' "${pkgdir}/boot/vmlinux"
}

package_linux-headers() {
    cd "${srcdir}/${pkgbase}-${pkgver}"
    make INSTALL_HDR_PATH=dest HOSTCFLAGS="-D_GNU_SOURCE" headers_install
    cd "${srcdir}/${pkgbase}-${pkgver}/dest"
    find include ! -type d -name "*.h" | cpio -dumpv "${pkgdir}"
}
