#!/bin/sh -xe
options=$(getopt -o p:n: -l rootfs:,name:,path: -- "$@")
[ $? -ne 0 ] && exit 1
eval set -- "$options"
while true
do
    case "$1" in
        -p|--path)      path=$2; shift 2;;
        -n|--name)      name=$2; shift 2;;
        --rootfs)       rootfs=$2; shift 2;;
        --)             shift 1; break ;;
        *)              break ;;
    esac
done

# detect rootfs
config="$path/config"
if [ -z "$rootfs" ]; then
    if grep -q '^lxc.rootfs' $config 2>/dev/null ; then
        rootfs=$(awk -F= '/^lxc.rootfs =/{ print $2 }' $config)
    else
        rootfs=$path/rootfs
    fi
fi

# Add required core directories/files
for dir in bin etc dev lib merebuild var/lib/pacman; do
    install -d -m0755 "${rootfs}/${dir}"
done
install -d -m0555 "${rootfs}/proc"
install -d -m0555 "${rootfs}/sys"
install -d -m1777 "${rootfs}/tmp"
install -d -m0755 "${rootfs}/tmp/staging"
install -m 0644 /etc/resolv.conf "${rootfs}/etc/"
ln -s /proc/mounts "${rootfs}/etc/mtab"

# /tools specific settings, for use when bootstrapping
if [ -n "$mere_use_tools" ] ; then
    install -d -m0755 "${rootfs}/tools"
    for file in $(find /tools/bin -maxdepth 1 ! -type d) ; do
        ln -s $file    "${rootfs}/bin/"
    done
    ln -s /tools/lib/libstdc++.a "${rootfs}/lib/"
fi

if [ -n "$mere_pacman_conf" ] && [ -f "$mere_pacman_conf" ] ; then
    pac_config="--config $mere_pacman_conf"
fi

if [ -z "$mere_base" ] ; then
    mere_base="base-layout build-essential"
fi

if [ "$mere_base" != 'none' ] ; then
    yes | pacman -Scc
    pacman -Syy -r "$rootfs" -b "${rootfs}/var/lib/pacman" \
        $pac_config --force --noconfirm $mere_base
    if [ -n "$pac_config" ]; then
        install -m0644 "$mere_pacman_conf" "${rootfs}/etc/"
    fi
fi

if [ -n "$mere_package" ] ; then
    if [ -d "$mere_package" ] ; then
        cp -a "$mere_package" "${rootfs}/tmp/wd"
    else
        printf "No such directory %s\n" "$mere_package"
        exit 1
    fi
fi
